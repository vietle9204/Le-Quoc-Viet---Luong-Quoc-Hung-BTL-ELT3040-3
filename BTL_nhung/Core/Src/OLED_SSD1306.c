#include "stm32f4xx.h"

#define LCD_ADDR (0x27 << 1)

<<<<<<< HEAD
		{ 0x00, 0x36, 0x36, 0x00, 0x00 }, // :
		{ 0x00, 0x56, 0x36, 0x00, 0x00 }, // ;
		{ 0x08, 0x14, 0x22, 0x41, 0x00 }, // <
		{ 0x14, 0x14, 0x14, 0x14, 0x14 }, // =
		{ 0x00, 0x41, 0x22, 0x14, 0x08 }, // >
		{ 0x02, 0x01, 0x51, 0x09, 0x06 }, // ?

		{ 0x32, 0x49, 0x79, 0x41, 0x3E }, // @
		{ 0x7E, 0x11, 0x11, 0x11, 0x7E }, // A
		{ 0x7F, 0x49, 0x49, 0x49, 0x36 }, // B
		{ 0x3E, 0x41, 0x41, 0x41, 0x22 }, // C
		{ 0x7F, 0x41, 0x41, 0x22, 0x1C }, // D
		{ 0x7F, 0x49, 0x49, 0x49, 0x41 }, // E
		{ 0x7F, 0x09, 0x09, 0x09, 0x01 }, // F
		{ 0x3E, 0x41, 0x49, 0x49, 0x7A }, // G
		{ 0xFF, 0x08, 0x08, 0x08, 0xFF }, // H
		{ 0x00, 0x41, 0x7F, 0x41, 0x00 }, // I
		{ 0x20, 0x40, 0x41, 0x3F, 0x01 }, // J
		{ 0x7F, 0x08, 0x14, 0x22, 0x41 }, // K
		{ 0x7F, 0x40, 0x40, 0x40, 0x40 }, // L
		{ 0x7F, 0x02, 0x0C, 0x02, 0x7F }, // M
		{ 0x7F, 0x04, 0x08, 0x10, 0x7F }, // N
		{ 0x3E, 0x41, 0x41, 0x41, 0x3E }, // O
		{ 0x7F, 0x09, 0x09, 0x09, 0x06 }, // P
		{ 0x3E, 0x41, 0x51, 0x21, 0x5E }, // Q
		{ 0x7F, 0x09, 0x19, 0x29, 0x46 }, // R
		{ 0x46, 0x49, 0x49, 0x49, 0x31 }, // S
		{ 0x01, 0x01, 0x7F, 0x01, 0x01 }, // T
		{ 0x3F, 0x40, 0x40, 0x40, 0x3F }, // U
		{ 0x1F, 0x20, 0x40, 0x20, 0x1F }, // V
		{ 0x3F, 0x40, 0x38, 0x40, 0x3F }, // W
		{ 0x63, 0x14, 0x08, 0x14, 0x63 }, // X
		{ 0x07, 0x08, 0x70, 0x08, 0x07 }, // Y
		{ 0x61, 0x51, 0x49, 0x45, 0x43 }, // Z

		{ 0x00, 0x7F, 0x41, 0x41, 0x00 }, // [
		{ 0x02, 0x04, 0x08, 0x10, 0x20 }, // backslash
		{ 0x00, 0x41, 0x41, 0x7F, 0x00 }, // ]
		{ 0x04, 0x02, 0x01, 0x02, 0x04 }, // ^
		{ 0x40, 0x40, 0x40, 0x40, 0x40 }, // _
		{ 0x00, 0x03, 0x07, 0x00, 0x00 }, // `

		{ 0x20, 0x54, 0x54, 0x54, 0x78 }, // a
		{ 0x20, 0x54, 0x54, 0x54, 0x78 }, // a
		{ 0x7F, 0x48, 0x44, 0x44, 0x38 }, // b
		{ 0x38, 0x44, 0x44, 0x44, 0x20 }, // c
		{ 0x38, 0x44, 0x44, 0x48, 0x7F }, // d
		{ 0x38, 0x54, 0x54, 0x54, 0x18 }, // e
		{ 0x08, 0x7E, 0x09, 0x01, 0x02 }, // f
		{ 0x0C, 0x52, 0x52, 0x52, 0x3E }, // g
		{ 0x7F, 0x08, 0x04, 0x04, 0x78 }, // h
		{ 0x00, 0x44, 0x7D, 0x40, 0x00 }, // i
		{ 0x20, 0x40, 0x44, 0x3D, 0x00 }, // j
		{ 0x7F, 0x10, 0x28, 0x44, 0x00 }, // k
		{ 0x00, 0x41, 0x7F, 0x40, 0x00 }, // l
		{ 0x7C, 0x04, 0x18, 0x04, 0x78 }, // m
		{ 0x7C, 0x08, 0x04, 0x04, 0x78 }, // n
		{ 0x38, 0x44, 0x44, 0x44, 0x38 }, // o
		{ 0x7C, 0x14, 0x14, 0x14, 0x08 }, // p
		{ 0x08, 0x14, 0x14, 0x18, 0x7C }, // q
		{ 0x7C, 0x08, 0x04, 0x04, 0x08 }, // r
		{ 0x48, 0x54, 0x54, 0x54, 0x20 }, // s
		{ 0x04, 0x3F, 0x44, 0x40, 0x20 }, // t
		{ 0x3C, 0x40, 0x40, 0x20, 0x7C }, // u
		{ 0x1C, 0x20, 0x40, 0x20, 0x1C }, // v
		{ 0x3C, 0x40, 0x30, 0x40, 0x3C }, // w
		{ 0x44, 0x28, 0x10, 0x28, 0x44 }, // x
		{ 0x0C, 0x50, 0x50, 0x50, 0x3C }, // y
		{ 0x44, 0x64, 0x54, 0x4C, 0x44 }, // z

		{ 0x00, 0x08, 0x36, 0x41, 0x00 }, // {
		{ 0x00, 0x00, 0x7F, 0x00, 0x00 }, // |
		{ 0x00, 0x41, 0x36, 0x08, 0x00 }, // }
		{ 0x08, 0x08, 0x2A, 0x1C, 0x08 }, // ~
};


void init_I2C_oled(void);

void ssd1306_send_cmd(uint8_t cmd)
{

}

void ssd1306_send_data(uint8_t *data, uint16_t size);

void ssd1306_init() {
	HAL_Delay(100);
	ssd1306_send_cmd(0xAE); // Tắt màn hình

	ssd1306_send_cmd(0x20); // Set Memory Addressing Mode
	ssd1306_send_cmd(0x00); // Horizontal addressing mode

	ssd1306_send_cmd(0xB0); // Page start address
	ssd1306_send_cmd(0xC8); // COM Output Scan Direction

	ssd1306_send_cmd(0x00); // Low column address
	ssd1306_send_cmd(0x10); // High column address

	ssd1306_send_cmd(0x40); // Start line address

	ssd1306_send_cmd(0x81); // Contrast
	ssd1306_send_cmd(0x7F);

	ssd1306_send_cmd(0xA1); // Segment re-map
	ssd1306_send_cmd(0xA6); // Normal display

	ssd1306_send_cmd(0xA8); // Multiplex ratio
	ssd1306_send_cmd(0x3F);

	ssd1306_send_cmd(0xA4); // Display entire on
	ssd1306_send_cmd(0xD3); // Display offset
	ssd1306_send_cmd(0x00);

	ssd1306_send_cmd(0xD5); // Display clock divide ratio
	ssd1306_send_cmd(0x80);

	ssd1306_send_cmd(0xD9); // Pre-charge period
	ssd1306_send_cmd(0xF1);

	ssd1306_send_cmd(0xDA); // COM pins hardware config
	ssd1306_send_cmd(0x12);

	ssd1306_send_cmd(0xDB); // VCOMH deselect
	ssd1306_send_cmd(0x40);

	ssd1306_send_cmd(0x8D); // Charge pump
	ssd1306_send_cmd(0x14);

	ssd1306_send_cmd(0xAF); // Bật màn hình
=======
void delay_ms(uint32_t ms);
void I2C1_Init(void);
void I2C1_Write(uint8_t addr, uint8_t *data, uint8_t len);
void lcd_send_cmd(char cmd);
void lcd_send_data(char data);
void lcd_init(void);
void lcd_puts(char *str);
void lcd_gotoxy(uint8_t col, uint8_t row);
int main(void)
{
    I2C1_Init();
    lcd_init();
    lcd_gotoxy(0, 0);
    lcd_puts("He thong:");
    lcd_gotoxy(0, 1);       // Di chuyển đến dòng 2, cột 0
    lcd_puts("Khi gas:");
    while (1) {}
>>>>>>> 0154b88dc1880da5581ef7c9717fefcf7b3f84b5
}

void delay_ms(uint32_t ms)
{
    for (uint32_t i = 0; i < ms * 4000; i++) __NOP();
}

void I2C1_Init(void)
{
    RCC->AHB1ENR |= RCC_AHB1ENR_GPIOBEN;
    RCC->APB1ENR |= RCC_APB1ENR_I2C1EN;

    GPIOB->MODER &= ~(GPIO_MODER_MODE6_Msk | GPIO_MODER_MODE7_Msk);
    GPIOB->MODER |= (2 << GPIO_MODER_MODE6_Pos) | (2 << GPIO_MODER_MODE7_Pos); // AF

    GPIOB->AFR[0] |= (4 << GPIO_AFRL_AFSEL6_Pos) | (4 << GPIO_AFRL_AFSEL7_Pos);
    GPIOB->OTYPER |= GPIO_OTYPER_OT6 | GPIO_OTYPER_OT7;
    GPIOB->PUPDR |= (1 << GPIO_PUPDR_PUPD6_Pos) | (1 << GPIO_PUPDR_PUPD7_Pos); // pull-up

    I2C1->CR1 &= ~I2C_CR1_PE;
    I2C1->CR2 = 16;      // APB1 = 16 MHz
    I2C1->CCR = 80;      // 100 kHz
    I2C1->TRISE = 17;
    I2C1->CR1 |= I2C_CR1_PE;
}

void I2C1_Write(uint8_t addr, uint8_t *data, uint8_t len)
{
    I2C1->CR1 |= I2C_CR1_START;
    while (!(I2C1->SR1 & I2C_SR1_SB));
    I2C1->DR = addr & ~0x01;
    while (!(I2C1->SR1 & I2C_SR1_ADDR));
    (void)I2C1->SR2;

    for (int i = 0; i < len; i++) {
        while (!(I2C1->SR1 & I2C_SR1_TXE));
        I2C1->DR = data[i];
    }

    while (!(I2C1->SR1 & I2C_SR1_BTF));
    I2C1->CR1 |= I2C_CR1_STOP;
}

void lcd_send_cmd(char cmd)
{
    char u = cmd & 0xF0;
    char l = (cmd << 4) & 0xF0;
    uint8_t data[4] = {
        u | 0x0C, u | 0x08,
        l | 0x0C, l | 0x08
    };
    I2C1_Write(LCD_ADDR, data, 4);
}

void lcd_send_data(char data_char)
{
    char u = data_char & 0xF0;
    char l = (data_char << 4) & 0xF0;
    uint8_t data[4] = {
        u | 0x0D, u | 0x09,
        l | 0x0D, l | 0x09
    };
    I2C1_Write(LCD_ADDR, data, 4);
}

void lcd_init(void)
{
    delay_ms(50);
    lcd_send_cmd(0x30); delay_ms(5);
    lcd_send_cmd(0x30); delay_ms(1);
    lcd_send_cmd(0x30); delay_ms(10);
    lcd_send_cmd(0x20); delay_ms(10);

    lcd_send_cmd(0x28); delay_ms(1);  // Function set
    lcd_send_cmd(0x08); delay_ms(1);  // Display off
    lcd_send_cmd(0x01); delay_ms(2);  // Clear
    lcd_send_cmd(0x06); delay_ms(1);  // Entry mode
    lcd_send_cmd(0x0C); delay_ms(1);  // Display on
}

void lcd_puts(char *str)
{
    while (*str) {
        lcd_send_data(*str++);
    }
}

void lcd_gotoxy(uint8_t col, uint8_t row)
{
    uint8_t address;

    switch (row)
    {
        case 0: address = 0x80 + col; break;  // Dòng 1
        case 1: address = 0xC0 + col; break;  // Dòng 2
        case 2: address = 0x94 + col; break;  // Dòng 3
        case 3: address = 0xD4 + col; break;  // Dòng 4
        default: return;  // Sai row thì không gửi lệnh
    }

    lcd_send_cmd(address);  // Gửi lệnh set DDRAM address
}
